<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Admin Panel</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom animation for the toast */
        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slide-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC50tfEA2h__peWlFCf4Dly5m_eEJ8br-s",
            authDomain: "bangla-story-9061a.firebaseapp.com",
            databaseURL: "https://bangla-story-9061a-default-rtdb.firebaseio.com",
            projectId: "bangla-story-9061a",
            storageBucket: "bangla-story-9061a.firebasestorage.app",
            messagingSenderId: "135733018669",
            appId: "1:135733018669:web:66e5c0903e612bf40538a4",
            measurementId: "G-X2W6RPC4PT"
        };

        // Global state management object
        const state = {
            db: null,
            auth: null,
            user: null,
            loading: true,
            error: null,
            activePanel: 'dataManagement',
            categories: [],
            selectedCategory: null,
            mainscreenimageUrl: '',
            subcollectionData: [],
            toastMessage: null,
            editMode: { docId: null, data: '' }
        };

        const appDiv = document.getElementById('app');

        // Helper function for creating icons (inline SVG)
        const getIcon = (name, size) => {
            let svgContent = '';
            switch (name) {
                case 'log-in':
                    svgContent = `<path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/>`;
                    break;
                case 'log-out':
                    svgContent = `<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>`;
                    break;
                case 'plus':
                    svgContent = `<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>`;
                    break;
                case 'pencil':
                    svgContent = `<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>`;
                    break;
                case 'trash-2':
                    svgContent = `<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>`;
                    break;
                case 'check-circle':
                    svgContent = `<path d="M22 11.08V12a10 10 0 1 1-5.93-8.8"/><polyline points="22 4 12 14.01 9 11.01"/>`;
                    break;
                case 'circle':
                    svgContent = `<circle cx="12" cy="12" r="10"/>`;
                    break;
                case 'bell':
                    svgContent = `<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>`;
                    break;
                default:
                    return '';
            }
            return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-${name}"><title>${name}</title>${svgContent}</svg>`;
        };

        // Initialize Firebase and set up auth listener
        const initializeFirebase = async () => {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                state.auth = firebase.auth();
                state.db = firebase.firestore();

                state.auth.onAuthStateChanged(currentUser => {
                    state.user = currentUser;
                    state.loading = false;
                    render();
                    if (currentUser) {
                        console.log("ব্যবহারকারী হিসাবে লগইন করেছেন:", currentUser.email);
                        setupListeners();
                    } else {
                        console.log("কোনো ব্যবহারকারী লগইন করেননি।");
                    }
                });
            } catch (e) {
                state.error = "Firebase ইনিশিয়ালাইজেশন ব্যর্থ হয়েছে: " + e.message;
                state.loading = false;
                render();
            }
        };

        // Set up Firestore listeners
        const setupListeners = () => {
            // Listen for categories and main screen image
            state.db.collection('category').onSnapshot(snapshot => {
                const categoryList = [];
                let mainScreenImg = '';
                snapshot.forEach(doc => {
                    if (doc.id === 'main_screen_background') {
                        mainScreenImg = doc.data()?.imageUrl || '';
                    } else {
                        categoryList.push({ id: doc.id, ...doc.data() });
                    }
                });
                state.categories = categoryList;
                state.mainscreenimageUrl = mainScreenImg;
                render();
            }, err => {
                console.error("ক্যাটাগরি লোড করতে ব্যর্থ:", err);
                state.error = "ক্যাটাগরি লোড করতে ব্যর্থ: " + err.message;
                render();
            });

            // Listen for subcollection data when a category is selected
            if (state.selectedCategory) {
                state.db.collection(`category/${state.selectedCategory.id}/all`).onSnapshot(snapshot => {
                    state.subcollectionData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, err => {
                    console.error("ডেটা লোড করতে ব্যর্থ:", err);
                    state.error = "ডেটা লোড করতে ব্যর্থ: " + err.message;
                    render();
                });
            }
        };

        // Show toast message
        const showToast = (message) => {
            state.toastMessage = message;
            render();
            setTimeout(() => {
                state.toastMessage = null;
                render();
            }, 3000);
        };

        // Main render function
        const render = () => {
            if (state.loading) {
                appDiv.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
                        <div class="text-center">
                            <p class="text-lg">অথেন্টিকেশন স্টেট চেক করা হচ্ছে...</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.error) {
                appDiv.innerHTML = `
                    <div class="p-4 bg-red-100 text-red-800 rounded-lg">
                        <p class="font-bold">ত্রুটি:</p>
                        <p>${state.error}</p>
                    </div>
                `;
                return;
            }

            if (!state.user) {
                renderLoginPage();
                return;
            }

            renderMainApp();
        };

        const renderLoginPage = () => {
            appDiv.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-100 font-sans p-4" style="background-image: url('https://placehold.co/1920x1080/4F46E5/ffffff?text=Admin+Login'); background-size: cover; background-position: center;">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md backdrop-blur-sm bg-white/80 border border-gray-200">
                        <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">অ্যাডমিন লগইন</h2>
                        <div id="login-error-message"></div>
                        <form id="login-form" class="space-y-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ইমেল</label>
                                <input id="email" type="email" class="w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring focus:ring-blue-200" placeholder="আপনার ইমেল লিখুন" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">পাসওয়ার্ড</label>
                                <input id="password" type="password" class="w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring focus:ring-blue-200" placeholder="আপনার পাসওয়ার্ড লিখুন" required />
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center gap-2" id="login-button">
                                ${getIcon('log-in', 20)} লগইন
                            </button>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginButton = document.getElementById('login-button');
                const errorMessageDiv = document.getElementById('login-error-message');

                loginButton.disabled = true;
                loginButton.innerHTML = 'লগইন হচ্ছে...';
                errorMessageDiv.innerHTML = '';

                try {
                    await state.auth.signInWithEmailAndPassword(email, password);
                    console.log("সফলভাবে লগইন করা হয়েছে।");
                } catch (e) {
                    console.error("লগইন ব্যর্থ হয়েছে:", e);
                    errorMessageDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4"><p>লগইন ব্যর্থ হয়েছে। দয়া করে আপনার ইমেল এবং পাসওয়ার্ড চেক করুন।</p></div>`;
                } finally {
                    loginButton.disabled = false;
                    loginButton.innerHTML = `${getIcon('log-in', 20)} লগইন`;
                }
            });
        };

        const renderMainApp = () => {
            const categoriesOptions = state.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            
            const dataManagementPanel = `
                <div class="lg:w-1/2 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">ডেটা ম্যানেজমেন্ট</h2>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-1">ক্যাটাগরি নির্বাচন করুন</label>
                        <select id="data-category-select" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="">-- একটি ক্যাটাগরি নির্বাচন করুন --</option>
                            ${categoriesOptions}
                        </select>
                    </div>
                    ${state.selectedCategory ? `
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">"${state.selectedCategory.name}" এর ডেটা</h3>
                    <div id="data-content-error"></div>
                    <div class="mb-4 p-4 border border-dashed border-gray-300 rounded-lg">
                        <h4 class="font-semibold text-base mb-2">নতুন ডেটা যোগ করুন</h4>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <textarea id="new-data-input" class="flex-grow rounded-md border-gray-300 shadow-sm p-2 min-h-[50px]" placeholder="নতুন ডেটা লিখুন..."></textarea>
                            <button id="add-data-btn" class="px-4 py-2 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition duration-200 sm:w-auto w-full flex items-center justify-center gap-2">
                                ${getIcon('plus', 18)} যোগ করুন
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3" id="subcollection-data-list">
                        ${state.subcollectionData.map(item => `
                            <div class="p-3 rounded-lg shadow-sm border border-gray-200 transition-colors duration-200 ${item.status === 'completed' ? 'bg-green-100' : 'bg-gray-50'}">
                                ${state.editMode.docId === item.id ? `
                                    <div class="space-y-2">
                                        <textarea id="edit-data-${item.id}" class="w-full rounded-md border-gray-300 shadow-sm p-2 min-h-[80px]">${item.data}</textarea>
                                        <div class="flex gap-2">
                                            <button data-doc-id="${item.id}" class="save-edit-btn px-3 py-1 text-sm bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition duration-200">
                                                সংরক্ষণ করুন
                                            </button>
                                            <button data-doc-id="${item.id}" class="cancel-edit-btn px-3 py-1 text-sm bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 transition duration-200">
                                                বাতিল
                                            </button>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                        <div class="flex-grow flex items-center gap-3">
                                            <button data-doc-id="${item.id}" data-status="${item.status}" class="toggle-status-btn text-sm rounded-full p-1 transition-all duration-200 ${item.status === 'completed' ? 'text-green-600 hover:text-green-700' : 'text-gray-400 hover:text-gray-600'}" title="${item.status === 'completed' ? 'সম্পূর্ণ' : 'অসম্পূর্ণ'}">
                                                ${item.status === 'completed' ? getIcon('check-circle', 24) : getIcon('circle', 24)}
                                            </button>
                                            <p class="flex-grow whitespace-pre-wrap text-gray-700 ${item.status === 'completed' ? 'line-through text-gray-500' : ''}">${item.data}</p>
                                        </div>
                                        <div class="flex gap-2">
                                            <button data-doc-id="${item.id}" data-data="${item.data}" class="edit-data-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600 transition duration-200 flex items-center">
                                                ${getIcon('pencil', 18)}
                                            </button>
                                            <button data-doc-id="${item.id}" class="delete-data-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 transition duration-200 flex items-center">
                                                ${getIcon('trash-2', 18)}
                                            </button>
                                        </div>
                                    </div>
                                `}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
            `;
            
            const categoryManagementPanel = `
                <div class="lg:w-1/2 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">নতুন ক্যাটাগরি যোগ করুন</h3>
                        <div id="add-category-error"></div>
                        <div class="space-y-2">
                            <input type="text" id="new-category-id" placeholder="ক্যাটাগরি আইডি (ঐচ্ছিক)" class="w-full rounded-md border-gray-300 shadow-sm p-2" />
                            <input type="text" id="new-category-name" placeholder="ক্যাটাগরির নাম" class="w-full rounded-md border-gray-300 shadow-sm p-2" />
                            <input type="text" id="new-category-image-url" placeholder="ব্যাকগ্রাউন্ড ইমেজ URL" class="w-full rounded-md border-gray-300 shadow-sm p-2" />
                            <button id="add-category-btn" class="w-full px-4 py-2 bg-purple-500 text-white font-bold rounded-lg shadow-md hover:bg-purple-600 transition duration-200 flex items-center justify-center gap-2">
                                ${getIcon('plus', 20)} যোগ করুন
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">ক্যাটাগরি সম্পাদনা ও মুছুন</h3>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-1">ক্যাটাগরি নির্বাচন করুন</label>
                            <select id="edit-category-select" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                                <option value="">-- একটি ক্যাটাগরি নির্বাচন করুন --</option>
                                ${categoriesOptions}
                            </select>
                        </div>
                        <div id="edit-category-error"></div>
                        ${state.selectedCategory ? `
                            <div class="space-y-4">
                                <label class="block">
                                    <span class="text-gray-700">নাম:</span>
                                    <input type="text" id="edit-category-name-input" value="${state.selectedCategory.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                                </label>
                                <label class="block">
                                    <span class="text-gray-700">ব্যাকগ্রাউন্ড ইমেজ URL:</span>
                                    <input type="text" id="edit-category-image-url-input" value="${state.selectedCategory.backgroundImageUrl}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                                </label>
                                <div class="flex gap-2">
                                    <button id="update-category-btn" class="w-full px-4 py-2 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-200 flex items-center justify-center gap-2">
                                        ${getIcon('pencil', 18)} আপডেট করুন
                                    </button>
                                    <button id="delete-category-btn" class="w-full px-4 py-2 bg-red-500 text-white font-bold rounded-lg shadow-md hover:bg-red-600 transition duration-200 flex items-center justify-center gap-2">
                                        ${getIcon('trash-2', 18)} মুছে ফেলুন
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">মেইন স্ক্রিন ইমেজ আপডেট</h2>
                        <div id="update-main-image-error"></div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="mainscreen-image-url-input" value="${state.mainscreenimageUrl}" placeholder="ইমেজ URL" class="flex-grow rounded-md border-gray-300 shadow-sm p-2" />
                            <button id="update-mainscreen-image-btn" class="px-4 py-2 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-200">
                                আপডেট করুন
                            </button>
                        </div>
                        ${state.mainscreenimageUrl ? `
                            <div class="mt-4">
                                <p class="font-semibold mb-2">বর্তমান ইমেজ:</p>
                                <img src="${state.mainscreenimageUrl}" alt="Main screen" class="w-full h-48 object-cover rounded-lg" onerror="this.src='https://placehold.co/600x400/CCCCCC/333333?text=Image+Not+Found';" />
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            const activePanelHTML = state.activePanel === 'dataManagement' ? dataManagementPanel : categoryManagementPanel;

            appDiv.innerHTML = `
                <div class="min-h-screen font-sans text-gray-800 p-4 sm:p-6 lg:p-8 bg-gray-100 transition-all duration-500" style="background-image: ${state.mainscreenimageUrl ? `url('${state.mainscreenimageUrl}')` : 'none'}; background-size: cover; background-position: center;">
                    <div class="max-w-7xl mx-auto space-y-8 backdrop-blur-sm bg-white/70 p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center pb-4 border-b border-gray-300">
                            <h1 class="text-3xl font-bold text-gray-900 drop-shadow-md">অ্যাডমিন প্যানেল</h1>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-700 hidden sm:block">হিসাবে লগইন করেছেন: <span class="font-semibold">${state.user.email}</span></span>
                                <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg shadow-md hover:bg-red-600 transition duration-200 flex items-center gap-2">
                                    ${getIcon('log-out', 18)} <span class="hidden sm:inline">লগআউট</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex justify-center gap-4 mb-8">
                            <button id="data-management-btn" class="px-6 py-3 rounded-lg font-bold transition-colors duration-200 ${state.activePanel === 'dataManagement' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                ডেটা ম্যানেজমেন্ট
                            </button>
                            <button id="category-management-btn" class="px-6 py-3 rounded-lg font-bold transition-colors duration-200 ${state.activePanel === 'categoryManagement' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                ক্যাটাগরি ম্যানেজমেন্ট
                            </button>
                        </div>
                        <div class="flex flex-col lg:flex-row gap-8">
                            ${activePanelHTML}
                        </div>
                    </div>
                </div>
                ${state.toastMessage ? `
                    <div class="fixed bottom-5 right-5 z-50 p-4 bg-green-500 text-white rounded-lg shadow-xl flex items-center gap-2 animate-slide-in">
                        ${getIcon('bell', 20)}
                        <span>${state.toastMessage}</span>
                    </div>
                ` : ''}
            `;
            
            // Re-attach event listeners after every render
            attachEventListeners();
        };

        const attachEventListeners = () => {
            // Main app listeners
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await state.auth.signOut();
                        state.selectedCategory = null;
                        render();
                        console.log("সফলভাবে লগআউট করা হয়েছে।");
                    } catch (e) {
                        console.error("লগআউট ব্যর্থ হয়েছে:", e);
                        state.error = "লগআউট করতে ব্যর্থ: " + e.message;
                        render();
                    }
                });
            }
            const dataManagementBtn = document.getElementById('data-management-btn');
            if (dataManagementBtn) {
                dataManagementBtn.addEventListener('click', () => {
                    state.activePanel = 'dataManagement';
                    render();
                });
            }
            const categoryManagementBtn = document.getElementById('category-management-btn');
            if (categoryManagementBtn) {
                categoryManagementBtn.addEventListener('click', () => {
                    state.activePanel = 'categoryManagement';
                    render();
                });
            }

            // Data Management Panel Listeners
            const dataCategorySelect = document.getElementById('data-category-select');
            if (dataCategorySelect) {
                dataCategorySelect.value = state.selectedCategory ? state.selectedCategory.id : '';
                dataCategorySelect.addEventListener('change', (e) => {
                    const categoryId = e.target.value;
                    state.selectedCategory = state.categories.find(cat => cat.id === categoryId) || null;
                    state.subcollectionData = []; // Clear old data
                    state.editMode = { docId: null, data: '' };
                    setupListeners();
                    render();
                });
            }
            const addDataBtn = document.getElementById('add-data-btn');
            if (addDataBtn) {
                addDataBtn.addEventListener('click', async () => {
                    const newDataInput = document.getElementById('new-data-input');
                    const contentErrorDiv = document.getElementById('data-content-error');
                    if (!state.db || !state.selectedCategory || !newDataInput.value) {
                        contentErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>নতুন ডেটা এবং একটি ক্যাটাগরি নির্বাচন করা আবশ্যক।</p></div>`;
                        return;
                    }
                    contentErrorDiv.innerHTML = '';
                    try {
                        const collectionRef = state.db.collection(`category/${state.selectedCategory.id}/all`);
                        await collectionRef.add({ data: newDataInput.value, status: 'incomplete' });
                        newDataInput.value = '';
                        showToast('নতুন ডেটা সফলভাবে যোগ করা হয়েছে!');
                    } catch (e) {
                        console.error("Error adding new item:", e);
                        contentErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>নতুন আইটেম যোগ করতে ব্যর্থ: ${e.message}</p></div>`;
                    }
                });
            }
            document.querySelectorAll('.toggle-status-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.currentTarget.dataset.docId;
                    const currentStatus = e.currentTarget.dataset.status;
                    const newStatus = currentStatus === 'completed' ? 'incomplete' : 'completed';
                    try {
                        const docRef = state.db.doc(`category/${state.selectedCategory.id}/all/${docId}`);
                        await docRef.update({ status: newStatus });
                        showToast('অবস্থা সফলভাবে আপডেট করা হয়েছে!');
                    } catch (e) {
                        console.error("Error updating status:", e);
                        document.getElementById('data-content-error').innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>অবস্থা আপডেট করতে ব্যর্থ: ${e.message}</p></div>`;
                    }
                });
            });
            document.querySelectorAll('.edit-data-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.docId;
                    const data = e.currentTarget.dataset.data;
                    state.editMode = { docId, data };
                    render();
                });
            });
            document.querySelectorAll('.save-edit-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.currentTarget.dataset.docId;
                    const newData = document.getElementById(`edit-data-${docId}`).value;
                    try {
                        const docRef = state.db.doc(`category/${state.selectedCategory.id}/all/${docId}`);
                        await docRef.update({ data: newData });
                        state.editMode = { docId: null, data: '' };
                        showToast('ডেটা সফলভাবে আপডেট করা হয়েছে!');
                    } catch (e) {
                        console.error("Error updating item:", e);
                        document.getElementById('data-content-error').innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>আইটেম আপডেট করতে ব্যর্থ: ${e.message}</p></div>`;
                    }
                });
            });
            document.querySelectorAll('.cancel-edit-btn').forEach(button => {
                button.addEventListener('click', () => {
                    state.editMode = { docId: null, data: '' };
                    render();
                });
            });
            document.querySelectorAll('.delete-data-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.currentTarget.dataset.docId;
                    try {
                        const docRef = state.db.doc(`category/${state.selectedCategory.id}/all/${docId}`);
                        await docRef.delete();
                        showToast('ডেটা সফলভাবে মুছে ফেলা হয়েছে!');
                    } catch (e) {
                        console.error("Error deleting item:", e);
                        document.getElementById('data-content-error').innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>আইটেম মুছে ফেলতে ব্যর্থ: ${e.message}</p></div>`;
                    }
                });
            });
            
            // Category Management Panel Listeners
            const editCategorySelect = document.getElementById('edit-category-select');
            if (editCategorySelect) {
                editCategorySelect.value = state.selectedCategory ? state.selectedCategory.id : '';
                editCategorySelect.addEventListener('change', (e) => {
                    const categoryId = e.target.value;
                    state.selectedCategory = state.categories.find(cat => cat.id === categoryId) || null;
                    render();
                });
            }
            const addCategoryBtn = document.getElementById('add-category-btn');
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', async () => {
                    const newCategoryId = document.getElementById('new-category-id').value;
                    const newCategoryName = document.getElementById('new-category-name').value;
                    const newCategoryImageUrl = document.getElementById('new-category-image-url').value;
                    const addErrorDiv = document.getElementById('add-category-error');

                    if (!state.db || !newCategoryName) {
                        addErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>ক্যাটাগরির নাম খালি রাখা যাবে না।</p></div>`;
                        return;
                    }
                    addErrorDiv.innerHTML = '';
                    try {
                        const collectionRef = state.db.collection('category');
                        if (newCategoryId) {
                            const docRef = collectionRef.doc(newCategoryId);
                            await docRef.set({ name: newCategoryName, backgroundImageUrl: newCategoryImageUrl });
                        } else {
                            await collectionRef.add({ name: newCategoryName, backgroundImageUrl: newCategoryImageUrl });
                        }
                        document.getElementById('new-category-id').value = '';
                        document.getElementById('new-category-name').value = '';
                        document.getElementById('new-category-image-url').value = '';
                        showToast('নতুন ক্যাটাগরি সফলভাবে যোগ করা হয়েছে!');
                    } catch (e) {
                        console.error("Error adding new category:", e);
                        addErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>নতুন ক্যাটাগরি যোগ করতে ব্যর্থ: ${e.message}</p></div>`;
                    }
                });
            }
            const updateCategoryBtn = document.getElementById('update-category-btn');
            if (updateCategoryBtn) {
                updateCategoryBtn.addEventListener('click', async () => {
                    const editErrorDiv = document.getElementById('edit-category-error');
                    if (!state.db || !state.selectedCategory) {
                        editErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>একটি ক্যাটাগরি নির্বাচন করা আবশ্যক।</p></div>`;
                        return;
                    }
                    editErrorDiv.innerHTML = '';
                    try {
                        const docRef = state.db.doc(`category/${state.selectedCategory.id}`);
                        const newName = document.getElementById('edit-category-name-input').value;
                        const newUrl = document.getElementById('edit-category-image-url-input').value;
                        await docRef.update({ name: newName, backgroundImageUrl: newUrl });
                        showToast('ক্যাটাগরি সফলভাবে আপডেট করা হয়েছে!');
                    } catch (e) {
                        console.error("Error updating category:", e);
                        editErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>ক্যাটাগরি আপডেট করতে ব্যর্থ: ${e.message}</p></div>`;
                    }
                });
            }
            const deleteCategoryBtn = document.getElementById('delete-category-btn');
            if (deleteCategoryBtn) {
                deleteCategoryBtn.addEventListener('click', async () => {
                    const editErrorDiv = document.getElementById('edit-category-error');
                    if (!state.db || !state.selectedCategory) {
                        editErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>একটি ক্যাটাগরি নির্বাচন করা আবশ্যক।</p></div>`;
                        return;
                    }
                    editErrorDiv.innerHTML = '';
                    try {
                        const docRef = state.db.doc(`category/${state.selectedCategory.id}`);
                        await docRef.delete();
                        state.selectedCategory = null;
                        render();
                        showToast('ক্যাটাগরি সফলভাবে মুছে ফেলা হয়েছে!');
                    } catch (e) {
                        console.error("Error deleting category:", e);
                        editErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>ক্যাটাগরি মুছে ফেলতে ব্যর্থ: ${e.message}</p></div>`;
                    }
                });
            }
            const updateMainscreenImageBtn = document.getElementById('update-mainscreen-image-btn');
            if (updateMainscreenImageBtn) {
                updateMainscreenImageBtn.addEventListener('click', async () => {
                    const newUrl = document.getElementById('mainscreen-image-url-input').value;
                    const updateMainImageErrorDiv = document.getElementById('update-main-image-error');
                    if (!state.db) return;
                    updateMainImageErrorDiv.innerHTML = '';
                    try {
                        const docRef = state.db.doc('category/main_screen_background');
                        await docRef.set({ imageUrl: newUrl });
                        showToast('মেইন স্ক্রিন ব্যাকগ্রাউন্ড সফলভাবে আপডেট করা হয়েছে!');
                    } catch (e) {
                        console.error("Error updating main screen image:", e);
                        updateMainImageErrorDiv.innerHTML = `<div class="p-2 bg-red-100 text-red-700 rounded-md mb-4"><p>মেইন স্ক্রিন ইমেজ আপডেট করতে ব্যর্থ: ${e.message}</p></div>`;
                    }
                });
            }
        };

        // Initial call to start the app
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });
    </script>
</body>
</html>
